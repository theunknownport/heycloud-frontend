{"ast":null,"code":"import { isEmptyObject, mapValues, toServerDuration, isNumber, isExperimentalFeatureEnabled } from '@datadog/browser-core';\nimport { RumEventType } from '../../../rawRumEvent.types';\nimport { LifeCycleEventType } from '../../lifeCycle';\nimport { supportPerformanceTimingEvent } from '../../../browser/performanceCollection';\nimport { trackViews } from './trackViews';\nexport function startViewCollection(lifeCycle, configuration, location, domMutationObservable, locationChangeObservable, foregroundContexts, recorderApi, initialViewName) {\n  lifeCycle.subscribe(LifeCycleEventType.VIEW_UPDATED, function (view) {\n    return lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, processViewUpdate(view, foregroundContexts, recorderApi));\n  });\n  return trackViews(location, lifeCycle, domMutationObservable, locationChangeObservable, !configuration.trackViewsManually, initialViewName);\n}\n\nfunction processViewUpdate(view, foregroundContexts, recorderApi) {\n  var replayStats = recorderApi.getReplayStats(view.id);\n  var viewEvent = {\n    _dd: {\n      document_version: view.documentVersion,\n      replay_stats: replayStats\n    },\n    date: view.startClocks.timeStamp,\n    type: RumEventType.VIEW,\n    view: {\n      action: {\n        count: view.eventCounts.userActionCount\n      },\n      cumulative_layout_shift: view.cumulativeLayoutShift,\n      dom_complete: toServerDuration(view.timings.domComplete),\n      dom_content_loaded: toServerDuration(view.timings.domContentLoaded),\n      dom_interactive: toServerDuration(view.timings.domInteractive),\n      error: {\n        count: view.eventCounts.errorCount\n      },\n      first_contentful_paint: toServerDuration(view.timings.firstContentfulPaint),\n      first_input_delay: toServerDuration(view.timings.firstInputDelay),\n      first_input_time: toServerDuration(view.timings.firstInputTime),\n      is_active: view.isActive,\n      name: view.name,\n      largest_contentful_paint: toServerDuration(view.timings.largestContentfulPaint),\n      load_event: toServerDuration(view.timings.loadEvent),\n      loading_time: discardNegativeDuration(toServerDuration(view.loadingTime)),\n      loading_type: view.loadingType,\n      long_task: {\n        count: view.eventCounts.longTaskCount\n      },\n      resource: {\n        count: view.eventCounts.resourceCount\n      },\n      time_spent: toServerDuration(view.duration),\n      in_foreground_periods: foregroundContexts.selectInForegroundPeriodsFor(view.startClocks.relative, view.duration)\n    },\n    session: {\n      has_replay: replayStats ? true : undefined\n    }\n  };\n\n  if (!isEmptyObject(view.customTimings)) {\n    viewEvent.view.custom_timings = mapValues(view.customTimings, toServerDuration);\n  }\n\n  return {\n    rawRumEvent: viewEvent,\n    startTime: view.startClocks.relative,\n    domainContext: {\n      location: view.location\n    },\n    customerContext: isExperimentalFeatureEnabled('monitor-dropped-lcp') && view.loadingType === 'initial_load' ? {\n      lcp: {\n        support: supportPerformanceTimingEvent('largest-contentful-paint'),\n        discard_reason: view.timings.lcpDiscardReason\n      }\n    } : undefined\n  };\n}\n\nfunction discardNegativeDuration(duration) {\n  return isNumber(duration) && duration < 0 ? undefined : duration;\n}","map":{"version":3,"sources":["../../../../src/domain/rumEventsCollection/view/viewCollection.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { isEmptyObject, mapValues, toServerDuration, isNumber, isExperimentalFeatureEnabled, } from '@datadog/browser-core';\nimport { RumEventType } from '../../../rawRumEvent.types';\nimport { LifeCycleEventType } from '../../lifeCycle';\nimport { supportPerformanceTimingEvent } from '../../../browser/performanceCollection';\nimport { trackViews } from './trackViews';\nexport function startViewCollection(lifeCycle, configuration, location, domMutationObservable, locationChangeObservable, foregroundContexts, recorderApi, initialViewName) {\n    lifeCycle.subscribe(LifeCycleEventType.VIEW_UPDATED, function (view) {\n        return lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, processViewUpdate(view, foregroundContexts, recorderApi));\n    });\n    return trackViews(location, lifeCycle, domMutationObservable, locationChangeObservable, !configuration.trackViewsManually, initialViewName);\n}\nfunction processViewUpdate(view, foregroundContexts, recorderApi) {\n    var replayStats = recorderApi.getReplayStats(view.id);\n    var viewEvent = {\n        _dd: {\n            document_version: view.documentVersion,\n            replay_stats: replayStats,\n        },\n        date: view.startClocks.timeStamp,\n        type: RumEventType.VIEW,\n        view: {\n            action: {\n                count: view.eventCounts.userActionCount,\n            },\n            cumulative_layout_shift: view.cumulativeLayoutShift,\n            dom_complete: toServerDuration(view.timings.domComplete),\n            dom_content_loaded: toServerDuration(view.timings.domContentLoaded),\n            dom_interactive: toServerDuration(view.timings.domInteractive),\n            error: {\n                count: view.eventCounts.errorCount,\n            },\n            first_contentful_paint: toServerDuration(view.timings.firstContentfulPaint),\n            first_input_delay: toServerDuration(view.timings.firstInputDelay),\n            first_input_time: toServerDuration(view.timings.firstInputTime),\n            is_active: view.isActive,\n            name: view.name,\n            largest_contentful_paint: toServerDuration(view.timings.largestContentfulPaint),\n            load_event: toServerDuration(view.timings.loadEvent),\n            loading_time: discardNegativeDuration(toServerDuration(view.loadingTime)),\n            loading_type: view.loadingType,\n            long_task: {\n                count: view.eventCounts.longTaskCount,\n            },\n            resource: {\n                count: view.eventCounts.resourceCount,\n            },\n            time_spent: toServerDuration(view.duration),\n            in_foreground_periods: foregroundContexts.selectInForegroundPeriodsFor(view.startClocks.relative, view.duration),\n        },\n        session: {\n            has_replay: replayStats ? true : undefined,\n        },\n    };\n    if (!isEmptyObject(view.customTimings)) {\n        viewEvent.view.custom_timings = mapValues(view.customTimings, toServerDuration);\n    }\n    return {\n        rawRumEvent: viewEvent,\n        startTime: view.startClocks.relative,\n        domainContext: {\n            location: view.location,\n        },\n        customerContext: isExperimentalFeatureEnabled('monitor-dropped-lcp') && view.loadingType === 'initial_load'\n            ? {\n                lcp: {\n                    support: supportPerformanceTimingEvent('largest-contentful-paint'),\n                    discard_reason: view.timings.lcpDiscardReason,\n                },\n            }\n            : undefined,\n    };\n}\nfunction discardNegativeDuration(duration) {\n    return isNumber(duration) && duration < 0 ? undefined : duration;\n}\n//# sourceMappingURL=viewCollection.js.map"]},"metadata":{},"sourceType":"module"}