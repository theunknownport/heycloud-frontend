{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { computeStackTrace, formatUnknownError, ErrorSource, generateUUID, ErrorHandling, Observable, trackConsoleError, trackRuntimeError } from '@datadog/browser-core';\nimport { RumEventType } from '../../../rawRumEvent.types';\nimport { LifeCycleEventType } from '../../lifeCycle';\nexport function startErrorCollection(lifeCycle, foregroundContexts) {\n  var errorObservable = new Observable();\n  trackConsoleError(errorObservable);\n  trackRuntimeError(errorObservable);\n  errorObservable.subscribe(function (error) {\n    return lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, {\n      error: error\n    });\n  });\n  return doStartErrorCollection(lifeCycle, foregroundContexts);\n}\nexport function doStartErrorCollection(lifeCycle, foregroundContexts) {\n  lifeCycle.subscribe(LifeCycleEventType.RAW_ERROR_COLLECTED, function (_a) {\n    var error = _a.error,\n        customerContext = _a.customerContext,\n        savedCommonContext = _a.savedCommonContext;\n    lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, __assign({\n      customerContext: customerContext,\n      savedCommonContext: savedCommonContext\n    }, processError(error, foregroundContexts)));\n  });\n  return {\n    addError: function (_a, savedCommonContext) {\n      var error = _a.error,\n          handlingStack = _a.handlingStack,\n          startClocks = _a.startClocks,\n          customerContext = _a.context;\n      var rawError = computeRawError(error, handlingStack, startClocks);\n      lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, {\n        customerContext: customerContext,\n        savedCommonContext: savedCommonContext,\n        error: rawError\n      });\n    }\n  };\n}\n\nfunction computeRawError(error, handlingStack, startClocks) {\n  var stackTrace = error instanceof Error ? computeStackTrace(error) : undefined;\n  return __assign(__assign({\n    startClocks: startClocks,\n    source: ErrorSource.CUSTOM,\n    originalError: error\n  }, formatUnknownError(stackTrace, error, 'Provided', handlingStack)), {\n    handling: ErrorHandling.HANDLED\n  });\n}\n\nfunction processError(error, foregroundContexts) {\n  var rawRumEvent = {\n    date: error.startClocks.timeStamp,\n    error: {\n      id: generateUUID(),\n      message: error.message,\n      resource: error.resource ? {\n        method: error.resource.method,\n        status_code: error.resource.statusCode,\n        url: error.resource.url\n      } : undefined,\n      source: error.source,\n      stack: error.stack,\n      handling_stack: error.handlingStack,\n      type: error.type,\n      handling: error.handling\n    },\n    type: RumEventType.ERROR\n  };\n  var inForeground = foregroundContexts.isInForegroundAt(error.startClocks.relative);\n\n  if (inForeground !== undefined) {\n    rawRumEvent.view = {\n      in_foreground: inForeground\n    };\n  }\n\n  return {\n    rawRumEvent: rawRumEvent,\n    startTime: error.startClocks.relative,\n    domainContext: {\n      error: error.originalError\n    }\n  };\n}","map":{"version":3,"sources":["../../../../src/domain/rumEventsCollection/error/errorCollection.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["import { __assign } from \"tslib\";\nimport { computeStackTrace, formatUnknownError, ErrorSource, generateUUID, ErrorHandling, Observable, trackConsoleError, trackRuntimeError, } from '@datadog/browser-core';\nimport { RumEventType } from '../../../rawRumEvent.types';\nimport { LifeCycleEventType } from '../../lifeCycle';\nexport function startErrorCollection(lifeCycle, foregroundContexts) {\n    var errorObservable = new Observable();\n    trackConsoleError(errorObservable);\n    trackRuntimeError(errorObservable);\n    errorObservable.subscribe(function (error) { return lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, { error: error }); });\n    return doStartErrorCollection(lifeCycle, foregroundContexts);\n}\nexport function doStartErrorCollection(lifeCycle, foregroundContexts) {\n    lifeCycle.subscribe(LifeCycleEventType.RAW_ERROR_COLLECTED, function (_a) {\n        var error = _a.error, customerContext = _a.customerContext, savedCommonContext = _a.savedCommonContext;\n        lifeCycle.notify(LifeCycleEventType.RAW_RUM_EVENT_COLLECTED, __assign({ customerContext: customerContext,\n            savedCommonContext: savedCommonContext }, processError(error, foregroundContexts)));\n    });\n    return {\n        addError: function (_a, savedCommonContext) {\n            var error = _a.error, handlingStack = _a.handlingStack, startClocks = _a.startClocks, customerContext = _a.context;\n            var rawError = computeRawError(error, handlingStack, startClocks);\n            lifeCycle.notify(LifeCycleEventType.RAW_ERROR_COLLECTED, {\n                customerContext: customerContext,\n                savedCommonContext: savedCommonContext,\n                error: rawError,\n            });\n        },\n    };\n}\nfunction computeRawError(error, handlingStack, startClocks) {\n    var stackTrace = error instanceof Error ? computeStackTrace(error) : undefined;\n    return __assign(__assign({ startClocks: startClocks, source: ErrorSource.CUSTOM, originalError: error }, formatUnknownError(stackTrace, error, 'Provided', handlingStack)), { handling: ErrorHandling.HANDLED });\n}\nfunction processError(error, foregroundContexts) {\n    var rawRumEvent = {\n        date: error.startClocks.timeStamp,\n        error: {\n            id: generateUUID(),\n            message: error.message,\n            resource: error.resource\n                ? {\n                    method: error.resource.method,\n                    status_code: error.resource.statusCode,\n                    url: error.resource.url,\n                }\n                : undefined,\n            source: error.source,\n            stack: error.stack,\n            handling_stack: error.handlingStack,\n            type: error.type,\n            handling: error.handling,\n        },\n        type: RumEventType.ERROR,\n    };\n    var inForeground = foregroundContexts.isInForegroundAt(error.startClocks.relative);\n    if (inForeground !== undefined) {\n        rawRumEvent.view = { in_foreground: inForeground };\n    }\n    return {\n        rawRumEvent: rawRumEvent,\n        startTime: error.startClocks.relative,\n        domainContext: {\n            error: error.originalError,\n        },\n    };\n}\n//# sourceMappingURL=errorCollection.js.map"]},"metadata":{},"sourceType":"module"}